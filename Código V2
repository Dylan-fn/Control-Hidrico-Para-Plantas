#include <WiFi.h>
#include <WebServer.h>

// --- CONFIGURACIÓN DE RED ---
const char* ssid = "A55 de Dylan";
const char* password = "12345678";
WebServer server(80);

// --- MAPEO DE HARDWARE ---
const int PUMP_PIN = 27;         
const int LED_ROJO_PIN = 13;     
const int LED_AMARILLO_PIN = 12; 
const int LED_VERDE_PIN = 14;    
const int SENSOR_PIN = 34;       

// --- UMBRALES ---
const int UMBRAL_SECO = 30;     
const int UMBRAL_HUMEDO = 65;   

int humedadPorcentaje = 0;    
bool estadoManualForzado = false; 
bool bombaActiva = false;       
bool estadoBlink = LOW;         

// --- FUNCIONES DE LECTURA ---

void leerSensorHumedad() {
    int valorAnalogico = analogRead(SENSOR_PIN); 
    humedadPorcentaje = map(valorAnalogico, 4095, 1500, 0, 100);
    humedadPorcentaje = constrain(humedadPorcentaje, 0, 100);
}

// --- LÓGICA DE GESTIÓN ---

void gestionarSistema() {
    leerSensorHumedad();

    // 1. Determinar estado de la bomba
    // La bomba se activa si el suelo está seco O si tú activaste el modo manual
    if (humedadPorcentaje < UMBRAL_SECO || estadoManualForzado) {
        bombaActiva = true;
        digitalWrite(PUMP_PIN, LOW); 
    } else {
        bombaActiva = false;
        digitalWrite(PUMP_PIN, HIGH); 
    }

    // 2. Control de LEDs con Advertencia
    digitalWrite(LED_ROJO_PIN, LOW);
    digitalWrite(LED_VERDE_PIN, LOW);
    digitalWrite(LED_AMARILLO_PIN, LOW);

    if (humedadPorcentaje < UMBRAL_SECO) {
        digitalWrite(LED_ROJO_PIN, HIGH);
    } 
    else if (humedadPorcentaje >= UMBRAL_HUMEDO) {
        // Si la bomba está encendida por manual en sobrehumedad, parpadea
        if (bombaActiva) digitalWrite(LED_AMARILLO_PIN, estadoBlink);
        else digitalWrite(LED_AMARILLO_PIN, HIGH);
    } 
    else {
        // Si la bomba está encendida por manual en óptimo, parpadea
        if (bombaActiva) digitalWrite(LED_VERDE_PIN, estadoBlink);
        else digitalWrite(LED_VERDE_PIN, HIGH);
    }
}

// --- INTERFAZ WEB ---

String buildHtmlPage() {
    String colorHumedad = "#2ecc71"; 
    if (humedadPorcentaje < UMBRAL_SECO) colorHumedad = "#e74c3c"; 
    else if (humedadPorcentaje >= UMBRAL_HUMEDO) colorHumedad = "#f1c40f"; 

    String html = "<!DOCTYPE html><html><head><meta charset='UTF-8'>";
    html += "<meta name='viewport' content='width=device-width, initial-scale=1'>";
    html += "<meta http-equiv='refresh' content='1'>"; 
    html += "<style>body{text-align:center; font-family:sans-serif; background:#f4f7f6;}";
    html += ".card{background:white; margin:20px auto; padding:25px; border-radius:15px; max-width:350px; box-shadow:0 5px 15px rgba(0,0,0,0.1);}";
    html += ".val{font-size:60px; font-weight:bold; color:" + colorHumedad + ";}";
    html += ".btn{padding:15px; border-radius:10px; color:white; border:none; cursor:pointer; font-size:16px;}";
    html += "</style></head><body>";
    
    html += "<div class='card'><h1>Smart Garden</h1>";
    html += "<h2>Estado del Suelo</h2>";
    html += "<div class='val'>" + String(humedadPorcentaje) + "%</div>";
    
    String msg = (humedadPorcentaje < UMBRAL_SECO) ? "¡Suelo Seco!" : 
                 (humedadPorcentaje >= UMBRAL_HUMEDO) ? "Sobrehumedad" : "Humedad Óptima";
    html += "<p style='color:" + colorHumedad + "; font-weight:bold;'>" + msg + "</p>";

    html += "<hr><h3>Control de Bomba</h3>";
    
    // El botón cambia de color y texto según si tú activaste el riego manual
    html += "<a href='/toggleRiego'><button class='btn' style='background:" + String(estadoManualForzado ? "#e74c3c" : "#3498db") + ";'>";
    html += (String)(estadoManualForzado ? "DESACTIVAR FORZADO" : "FORZAR ENCENDIDO") + "</button></a>";
    
    if (estadoManualForzado) {
        html += "<p style='color:#e74c3c;'><strong>BOMBA FORZADA POR USUARIO</strong></p>";
    } else if (bombaActiva) {
        html += "<p style='color:#2ecc71;'><strong>Riego Automático Activo</strong></p>";
    } else {
        html += "<p style='color:gray;'>Sistema en espera...</p>";
    }
    
    html += "</div></body></html>";
    return html;
}

void handleRoot() { server.send(200, "text/html", buildHtmlPage()); }

// Esta función permite encender/apagar manualmente sin romper la lógica del sensor
void handleToggleRiego() { 
    estadoManualForzado = !estadoManualForzado; 
    server.sendHeader("Location", "/"); 
    server.send(303); 
}

// --- SETUP Y LOOP ---

void setup() {
    Serial.begin(115200);
    pinMode(PUMP_PIN, OUTPUT);
    pinMode(LED_ROJO_PIN, OUTPUT);
    pinMode(LED_AMARILLO_PIN, OUTPUT);
    pinMode(LED_VERDE_PIN, OUTPUT);
    
    digitalWrite(PUMP_PIN, HIGH); 
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED) { delay(500); Serial.print("."); }
    
    server.on("/", handleRoot);
    server.on("/toggleRiego", handleToggleRiego);
    server.begin();
}

void loop() {
    server.handleClient();
    
    static unsigned long lastTick = 0;
    if (millis() - lastTick >= 500) {
        estadoBlink = !estadoBlink; 
        gestionarSistema();
        lastTick = millis();
    }
}
